<!DOCTYPE html>
<html>
  <head>
    <title>2014 Champions League final tweets pulse | Twitter + CartoDB</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="shortcut icon" href="img/favicon.ico" />

    <meta name="description" content="Visualization about the amount of tweets during 2014 Champions League final between Rel Madrid and Atlético de Madrid" />
    <meta name="keywords" content="cartodb, champions league, tweets, goal, 2014 lisbon, soccer, football" />
    <meta name="distribution" content="Global">
    <meta name="author" content="Twitter + CartoDB">
    <meta name="detail" content="Twitter pulse along 2014 Champions League final">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta property="og:title" content="Twitter pulse along 2014 Champions League final"/>
    <meta property="og:description" content="Visualization about the amount of tweets during 2014 Champions League final between Rel Madrid and Atlético de Madrid"/> 
    <meta property="og:type" content="Visualization"/>
    <meta property="og:url" content="http://cartodb.github.io/2014-lisbon" />
    
    <meta property="og:image" content="img/thumbnail.png"/>

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@cartodb">
    <meta name="twitter:title" content="Twitter pulse along 2014 Champions League final">
    <meta name="twitter:description" content="Visualization about the amount of tweets during 2014 Champions League final between Rel Madrid and Atlético de Madrid">
    <meta name="twitter:creator" content="@cartodb">
    <meta name="twitter:image:src" content="img/thumbnail.png">
    <meta name="twitter:domain" content="github.com">
    
    <link rel="canonical" href="http://cartodb.github.io/2014-lisbon">

    <link href='http://fonts.googleapis.com/css?family=Rokkitt:700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/normalize.css" />
    <link rel="stylesheet" href="css/tipsy.css" />
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
    <link rel="stylesheet" href="css/match.css" />
  </head>
  <body>
    <div id="map"></div>

    <script type="infowindow/html" id="match_slider">

      <div class="head">
        <ul>
          <li><h2 class="madrid">Real Madrid</h2></li>
          <li>
            <div class="score">
              <em class="madrid">0</em>
              <em class="separator">-</em>
              <em class="atletico">0</em>
            </div>
          </li>
          <li><h2 class="atletico">Atl. de Madrid</h2></li>
        </ul>

        <div class="time">
          <p class="value"></p>  
        </div>
      </div>

      <div class="highlights">
        <div class="team madrid">
          <div class="madrid logo"></div>
          <div class="timeline"></div>
        </div>
        <div class="timeslider">
          <a href='#/stop' class='button stop'>pause</a>
          <div class="wrap_slider">
            <div class="slider"></div>
          </div>
        </div>
        <div class="team atletico">
          <div class="atletico logo"></div>
          <div class="timeline"></div>
        </div>
      </div>
    </script>


    <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>
    <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.mod.torque.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/match_slider.js"></script>
    <script src="js/tipsy.js"></script>
    <script src="js/match_data.js"></script>
    

    <script>

      torque.providers.windshaft.prototype.aggregateByKey = function(callback) {
        var url = this.templateUrl
                  .replace('{x}', 0)
                  .replace('{y}', 0)
                  .replace('{z}', 0)
                  .replace('{s}', 0)
 
        var self = this;
        var extra = this._extraParams();
        torque.net.get( url,  function (data) {
          var rows = JSON.parse(data.responseText);
          callback(self._aggregateByKey(rows));
        })
      }
      torque.providers.windshaft.prototype._aggregateByKey = function(rows) {
        function getKeys(row) {
          var keys = {};
          var dates = row.dates__uint16;
          var vals = row.vals__uint8;
          var valuesCount = vals.length;
          for (var s = 0; s < valuesCount; ++s) {
            keys[dates[s]] = vals[s];
          }
          return keys;
        }
 
        var keys = {};
        for (r = 0; r < rows.length; ++r) {
          var rowKeys = getKeys(rows[r]);
          for(var k in rowKeys) {
            keys[k] = keys[k] || 0;
            keys[k] += rowKeys[k];
          }
        }
        return keys;
      }

      var torqueLayer;

      function main() {
        
        var map = L.map('map', { 
          zoomControl: false,
          center: [38.722252, -9.139337],
          zoom: 3
        });

        cdb.vis.Overlay.register('match_slider', function(data, viz) {
          data.template = $('#match_slider').html(); 
          var slider = new MatchSlider(data);
          return slider.render();
        });

        // add a nice baselayer from Stamen 
        L.tileLayer('https://cartocdn_{s}.global.ssl.fastly.net/base-dark/{z}/{x}/{y}.png').addTo(map);

        cartodb.createLayer(map, 'https://srogers.cartodb.com/api/v2/viz/337d9194-6458-11e3-85b5-e5e70547d141/viz.json',{
          time_slider: false
        })
          .addTo(map)
          .done(function(layer) {

            var hash = new L.Hash(map, layer);

            slider = map.viz.addOverlay({
              type: 'match_slider',
              layer: layer
            });
            
            torqueLayer = layer;
            torqueLayer.stop();

            torqueLayer.on('load', function() {
              torqueLayer.play();

              drawStartEnd()
            });

            torqueLayer.on('change:time', checkTime);
          })
          .error(function(err) {
            console.log(err);
          });
      }

      function checkTime(data) {

        _.each(match_data.highlights, function(d,i) {
          
          // Block
          var block = d.team.indexOf('Atlético') !== -1 ? 'atletico' : 'madrid';

          if (new Date(data.time) >= new Date(i)) {
            
            if (!d.el) {

              var div = $('<div>').addClass('highlight ' + block);

              div.append($('<i>')
                  .addClass("icon " + d.type + " ")
                  .attr('data-tipsy', d.text)
                  .append(d.type));
              
              div.append($('<span>').addClass('line'));

              d.el = div;

              var pos = getHighlightPos(new Date(i).getTime());

              // Position
              d.el.css({
                left: pos + "%"
              });

              $('.highlights').find('.' + block + ' .timeline').append(d.el);

              generateTooltip(d.el.find('i'));

              if (d.type === "goal") {
                var goals = parseInt($('em.' + block).text());
                $('em.' + block).text(++goals);
              }
            }

            d.el.show();
          } else {
            
            if (d.el && d.type === "goal") {
              var goals = parseInt($('em.' + block).text());
              $('em.' + block).text(--goals);
            }

            if (d.el) {
              d.el
                .hide()
                .remove();

              delete d.el;
            }
          }
          
        })
      }

      function generateTooltip($el) {
        
        $el.tipsy({
          // trigger:  'manual',
          title:    function() {
            return this.getAttribute('data-tipsy') + ''
          },
          html:     true,
          gravity:  $.fn.tipsy.autoBounds(250, 's'),
          fade:     true,
          delayIn:  300,
          delayOut: 750
        })

        // $('#mylink').attr('title','Input here:<input id="toolbar">');
        // $('#mylink').tipsy({trigger:'manual',gravity:'w', html:true});

        // //.tipsy class is what the generated tooltip divs have, so we use the 
        // //live event to link the mouseover/mouseout events
        // $('.tipsy').live('mouseover',function(e){
        //   clearTimeout(timer);
        // });
        // $('.tipsy').live('mouseout',function(e){
        //   timer = setTimeout("$('#mylink').tipsy('hide');",3000);//hide the link in 3 seconds
        // });

        // //manually show the tooltip
        // $('#mylink').bind('mouseover',function(e){
        //    $(this).tipsy('show');
        //  });
      }

      function getHighlightPos(timestamp)  {
        var tb = torqueLayer.getTimeBounds();
        return ((timestamp-tb.start)*100)/(tb.end-tb.start);
      }

      function drawStartEnd() {

        if ($('.icon.start').length > 0) {
          return false;
        }

        // Draw start
        var div = $('<div>').addClass('highlight');
        div.append($('<i>').addClass("icon start"));
        div.append($('<span>').addClass('separator'));
        div.append($('<p>').text(match_data.start.text));
        var pos = getHighlightPos(new Date(match_data.start.time).getTime());
        
        div.css({ left: pos + "%" });
        $('.highlights .timeslider').find('.wrap_slider')
          .append(div)
          .append(
            $('<span>')
              .addClass('slider_mamufas start')
              .css({
                left: 0,
                width: pos + '%'
              })
          );

        // Draw end
        var div = $('<div>').addClass('highlight');
        div.append($('<i>').addClass("icon end"));
        div.append($('<span>').addClass('separator'));
        div.append($('<p>').text(match_data.end.text));
        var pos = getHighlightPos(new Date(match_data.end.time).getTime());
        
        div.css({ left: pos + "%" });
        $('.highlights .timeslider').find('.wrap_slider')
          .append(div)
          .append(
            $('<span>')
              .addClass('slider_mamufas end')
              .css({
                right: 0,
                left: pos + "%"
              })
          );
      }

      window.onload = main;
    </script>
  </body>
</html>